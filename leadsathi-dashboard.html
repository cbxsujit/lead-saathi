<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadSathi - Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --primary-light: #06b6d4;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --bg: #f8fafc;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --card-bg: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #e0f2fe 100%);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .last-updated {
            font-size: 14px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(8, 145, 178, 0.4);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--error);
        }

        .stat-change.neutral {
            color: var(--text-tertiary);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.8s ease-out backwards;
        }

        .chart-card:nth-child(1) { animation-delay: 0.5s; }
        .chart-card:nth-child(2) { animation-delay: 0.6s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .chart-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Trend Chart */
        .trend-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            animation: fadeIn 0.8s ease-out 0.7s backwards;
        }

        .trend-chart-container {
            position: relative;
            height: 350px;
        }

        /* Recent Leads Table */
        .table-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.8s ease-out 0.8s backwards;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .leads-table thead {
            background: var(--bg);
        }

        .leads-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .leads-table td {
            padding: 12px;
            border-top: 1px solid var(--border);
            font-size: 14px;
        }

        .leads-table tbody tr {
            transition: background 0.2s ease;
        }

        .leads-table tbody tr:hover {
            background: var(--bg);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-walk-in { background: #dbeafe; color: #1e40af; }
        .badge-phone { background: #fef3c7; color: #92400e; }
        .badge-whatsapp { background: #d1fae5; color: #065f46; }
        .badge-referral { background: #e0e7ff; color: #3730a3; }
        .badge-exhibition { background: #fce7f3; color: #831843; }
        .badge-website { background: #ddd6fe; color: #5b21b6; }

        .mobile-badge {
            font-family: monospace;
            background: var(--bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid #fecaca;
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 28px;
            }

            .leads-table {
                font-size: 12px;
            }

            .leads-table th,
            .leads-table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .header {
                padding: 16px;
            }

            .stat-card {
                padding: 16px;
            }

            .chart-card,
            .trend-card,
            .table-card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo-icon">ðŸ“Š</div>
                <div>
                    <h1>LeadSathi Dashboard</h1>
                    <div class="last-updated">
                        <span class="pulse"></span>
                        <span id="lastUpdated">Live</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshData()">
                    ðŸ”„ Refresh
                </button>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading dashboard data...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="totalLeads">0</div>
                    <div class="stat-change neutral">
                        <span>All time</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Today</div>
                    <div class="stat-value" id="todayLeads">0</div>
                    <div class="stat-change" id="todayChange">
                        <span>â€”</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value" id="weekLeads">0</div>
                    <div class="stat-change" id="weekChange">
                        <span>â€”</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value" id="monthLeads">0</div>
                    <div class="stat-change neutral">
                        <span>Last 30 days</span>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <!-- Lead Sources Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Lead Sources</div>
                        <div class="chart-subtitle">Where your leads come from</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sourcesChart"></canvas>
                    </div>
                </div>

                <!-- Business Types Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Business Types</div>
                        <div class="chart-subtitle">Distribution by industry</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="businessTypesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Trend Chart -->
            <div class="trend-card">
                <div class="chart-header">
                    <div class="chart-title">Lead Trend</div>
                    <div class="chart-subtitle">Daily lead capture over last 30 days</div>
                </div>
                <div class="trend-chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Recent Leads Table -->
            <div class="table-card">
                <div class="table-header">
                    <div>
                        <div class="chart-title">Recent Leads</div>
                        <div class="chart-subtitle">Latest 10 captured leads</div>
                    </div>
                </div>
                <div id="recentLeadsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ IMPORTANT: Use the same Google Apps Script Web App URL as your form
        const API_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhwV8M_VV-lKWh5lNVIO66TLDlZIJ9lp_jN6W3yNVJNh_gbKRRl6zSVJSK83nOf0hYiHC0Sv6yKll-kldlthkmJUToMCUeJRdVDGwd06kCAYKh1nCvNEmtS7MmvdDd1tff9FcmyXAvWxu9DXmgjqt7P5jdi2aAUoZdifZCnZHAD5JzysRYBGKIu9_V4r1mjPt4YeiTDn7EsW6S5uAhSvDXRafA81_wMpnMVOJ41xoitZ8yJN3TGsAGhM3xD4S-Mi6MRNMMezwEfQDSsUnaG_2gqaV13faa-epq_NHMb&lib=MF9d60emV0zTzk7_3z-FE2Ear53hw2-_X';
        
        let charts = {
            sources: null,
            businessTypes: null,
            trend: null
        };

        // Initialize dashboard
        async function initDashboard() {
            try {
                await loadAllData();
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                
                // Auto-refresh every 30 seconds
                setInterval(refreshData, 30000);
            } catch (error) {
                showError('Failed to load dashboard: ' + error.message);
            }
        }

        // Load all data
        async function loadAllData() {
            try {
                const [stats, sources, businessTypes, trend, recent] = await Promise.all([
                    fetchData('stats'),
                    fetchData('sources'),
                    fetchData('businessTypes'),
                    fetchData('trend', '&days=30'),
                    fetchData('recent', '&limit=10')
                ]);

                updateStats(stats);
                updateSourcesChart(sources);
                updateBusinessTypesChart(businessTypes);
                updateTrendChart(trend);
                updateRecentLeads(recent);
                updateLastUpdated();
            } catch (error) {
                throw error;
            }
        }

        // Fetch data from API
        async function fetchData(action, params = '') {
            const response = await fetch(`${API_URL}?action=${action}${params}`);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result.data;
        }

        // Update stats cards
        function updateStats(data) {
            const overview = data.overview;
            const growth = data.growth;

            document.getElementById('totalLeads').textContent = overview.total;
            document.getElementById('todayLeads').textContent = overview.today;
            document.getElementById('weekLeads').textContent = overview.week;
            document.getElementById('monthLeads').textContent = overview.month;

            // Today change
            const todayChangeEl = document.getElementById('todayChange');
            if (growth.todayVsYesterday !== 0) {
                const arrow = growth.todayVsYesterday > 0 ? 'â†‘' : 'â†“';
                todayChangeEl.innerHTML = `<span>${arrow} ${Math.abs(growth.todayVsYesterday)}% vs yesterday</span>`;
                todayChangeEl.className = growth.todayVsYesterday > 0 ? 'stat-change positive' : 'stat-change negative';
            }

            // Week change
            const weekChangeEl = document.getElementById('weekChange');
            if (growth.weekVsLastWeek !== 0) {
                const arrow = growth.weekVsLastWeek > 0 ? 'â†‘' : 'â†“';
                weekChangeEl.innerHTML = `<span>${arrow} ${Math.abs(growth.weekVsLastWeek)}% vs last week</span>`;
                weekChangeEl.className = growth.weekVsLastWeek > 0 ? 'stat-change positive' : 'stat-change negative';
            }
        }

        // Update sources chart
        function updateSourcesChart(data) {
            const ctx = document.getElementById('sourcesChart').getContext('2d');
            
            if (charts.sources) {
                charts.sources.destroy();
            }

            if (!data.sources || data.sources.length === 0) {
                return;
            }

            charts.sources = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.sources.map(s => s.name),
                    datasets: [{
                        data: data.sources.map(s => s.count),
                        backgroundColor: [
                            '#0891b2',
                            '#06b6d4',
                            '#22d3ee',
                            '#67e8f9',
                            '#a5f3fc',
                            '#cffafe'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    family: 'DM Sans',
                                    size: 13
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = data.sources[context.dataIndex].percentage;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update business types chart
        function updateBusinessTypesChart(data) {
            const ctx = document.getElementById('businessTypesChart').getContext('2d');
            
            if (charts.businessTypes) {
                charts.businessTypes.destroy();
            }

            if (!data.businessTypes || data.businessTypes.length === 0) {
                return;
            }

            charts.businessTypes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.businessTypes.map(b => b.name),
                    datasets: [{
                        label: 'Leads',
                        data: data.businessTypes.map(b => b.count),
                        backgroundColor: 'rgba(8, 145, 178, 0.8)',
                        borderColor: '#0891b2',
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = data.businessTypes[context.dataIndex].percentage;
                                    return `${value} leads (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Update trend chart
        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trend) {
                charts.trend.destroy();
            }

            if (!data.trend || data.trend.length === 0) {
                return;
            }

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.trend.map(t => t.date),
                    datasets: [{
                        label: 'Leads',
                        data: data.trend.map(t => t.count),
                        borderColor: '#0891b2',
                        backgroundColor: 'rgba(8, 145, 178, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#0891b2',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Update recent leads table
        function updateRecentLeads(data) {
            const container = document.getElementById('recentLeadsContainer');
            
            if (!data.leads || data.leads.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><p>No leads captured yet</p></div>';
                return;
            }

            let html = '<table class="leads-table"><thead><tr>';
            html += '<th>Time</th>';
            html += '<th>Name</th>';
            html += '<th>Mobile</th>';
            html += '<th>Business Type</th>';
            html += '<th>Source</th>';
            html += '</tr></thead><tbody>';

            data.leads.forEach(lead => {
                const sourceClass = lead.leadSource.toLowerCase().replace(/\s+/g, '-');
                html += '<tr>';
                html += `<td>${lead.timestamp.split(' ')[1] || ''}</td>`;
                html += `<td><strong>${lead.name}</strong></td>`;
                html += `<td><span class="mobile-badge">${lead.mobile}</span></td>`;
                html += `<td>${lead.businessType}</td>`;
                html += `<td><span class="badge badge-${sourceClass}">${lead.leadSource}</span></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastUpdated').innerHTML = `<span class="pulse"></span> Updated at ${timeStr}`;
        }

        // Refresh data
        async function refreshData() {
            try {
                hideError();
                await loadAllData();
            } catch (error) {
                showError('Failed to refresh: ' + error.message);
            }
        }

        // Show error
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = 'âš ï¸ ' + message;
            errorEl.style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initDashboard();
        });

        // Check configuration
        if (API_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            showError('Please configure the API_URL with your Google Apps Script Web App URL');
        }
    </script>
</body>
</html>